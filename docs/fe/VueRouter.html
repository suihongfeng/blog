<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VueRouter 源码 | 天宝的博客</title>
    <meta name="description" content="执着于更高的技术追求！">
    <link rel="icon" href="ltbicon.ico">
  <meta name="theme-color" content="#3eaf7c">
    
    <link rel="preload" href="/blog/assets/css/0.styles.9c798782.css" as="style"><link rel="preload" href="/blog/assets/js/app.aa3db317.js" as="script"><link rel="preload" href="/blog/assets/js/2.88c654cf.js" as="script"><link rel="preload" href="/blog/assets/js/23.af7d3482.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.f45604f1.js"><link rel="prefetch" href="/blog/assets/js/100.d65f38fe.js"><link rel="prefetch" href="/blog/assets/js/101.3dd27ed1.js"><link rel="prefetch" href="/blog/assets/js/11.9acceaff.js"><link rel="prefetch" href="/blog/assets/js/12.f45271ca.js"><link rel="prefetch" href="/blog/assets/js/13.6baf8f7b.js"><link rel="prefetch" href="/blog/assets/js/14.195fb558.js"><link rel="prefetch" href="/blog/assets/js/15.02c62ea1.js"><link rel="prefetch" href="/blog/assets/js/16.b4288c43.js"><link rel="prefetch" href="/blog/assets/js/17.c2aa7160.js"><link rel="prefetch" href="/blog/assets/js/18.b27594ef.js"><link rel="prefetch" href="/blog/assets/js/19.7e043128.js"><link rel="prefetch" href="/blog/assets/js/20.f472a0aa.js"><link rel="prefetch" href="/blog/assets/js/21.134d0d14.js"><link rel="prefetch" href="/blog/assets/js/22.3e2c5b4f.js"><link rel="prefetch" href="/blog/assets/js/24.59d933a6.js"><link rel="prefetch" href="/blog/assets/js/25.52b25e31.js"><link rel="prefetch" href="/blog/assets/js/26.65ddb3e3.js"><link rel="prefetch" href="/blog/assets/js/27.8d564bc6.js"><link rel="prefetch" href="/blog/assets/js/28.41d5c25a.js"><link rel="prefetch" href="/blog/assets/js/29.ded695e7.js"><link rel="prefetch" href="/blog/assets/js/3.b6b2f2d6.js"><link rel="prefetch" href="/blog/assets/js/30.518b7df6.js"><link rel="prefetch" href="/blog/assets/js/31.e1e1d886.js"><link rel="prefetch" href="/blog/assets/js/32.d390d66e.js"><link rel="prefetch" href="/blog/assets/js/33.71242726.js"><link rel="prefetch" href="/blog/assets/js/34.26e3a8a2.js"><link rel="prefetch" href="/blog/assets/js/35.875ea53e.js"><link rel="prefetch" href="/blog/assets/js/36.c9030464.js"><link rel="prefetch" href="/blog/assets/js/37.afc6cddb.js"><link rel="prefetch" href="/blog/assets/js/38.a2a0b76c.js"><link rel="prefetch" href="/blog/assets/js/39.70685f6c.js"><link rel="prefetch" href="/blog/assets/js/4.7e237ac0.js"><link rel="prefetch" href="/blog/assets/js/40.41e24fd4.js"><link rel="prefetch" href="/blog/assets/js/41.b5e217d7.js"><link rel="prefetch" href="/blog/assets/js/42.27264fec.js"><link rel="prefetch" href="/blog/assets/js/43.98847869.js"><link rel="prefetch" href="/blog/assets/js/44.e30c375c.js"><link rel="prefetch" href="/blog/assets/js/45.9335fdcc.js"><link rel="prefetch" href="/blog/assets/js/46.d0b72537.js"><link rel="prefetch" href="/blog/assets/js/47.fca7d395.js"><link rel="prefetch" href="/blog/assets/js/48.81048913.js"><link rel="prefetch" href="/blog/assets/js/49.bd4d42e8.js"><link rel="prefetch" href="/blog/assets/js/5.2ce2966b.js"><link rel="prefetch" href="/blog/assets/js/50.9e741114.js"><link rel="prefetch" href="/blog/assets/js/51.d18bcdee.js"><link rel="prefetch" href="/blog/assets/js/52.d99cbaf2.js"><link rel="prefetch" href="/blog/assets/js/53.e6a08815.js"><link rel="prefetch" href="/blog/assets/js/54.45e34776.js"><link rel="prefetch" href="/blog/assets/js/55.5ea7e06a.js"><link rel="prefetch" href="/blog/assets/js/56.67bcdb88.js"><link rel="prefetch" href="/blog/assets/js/57.bbdbb3d0.js"><link rel="prefetch" href="/blog/assets/js/58.b783e7a4.js"><link rel="prefetch" href="/blog/assets/js/59.77e540cd.js"><link rel="prefetch" href="/blog/assets/js/6.2beb955c.js"><link rel="prefetch" href="/blog/assets/js/60.3534e4db.js"><link rel="prefetch" href="/blog/assets/js/61.27ce2009.js"><link rel="prefetch" href="/blog/assets/js/62.52448625.js"><link rel="prefetch" href="/blog/assets/js/63.dbf5f4af.js"><link rel="prefetch" href="/blog/assets/js/64.3f655ef8.js"><link rel="prefetch" href="/blog/assets/js/65.d93dd3ca.js"><link rel="prefetch" href="/blog/assets/js/66.cba5c127.js"><link rel="prefetch" href="/blog/assets/js/67.c677a68a.js"><link rel="prefetch" href="/blog/assets/js/68.4275e514.js"><link rel="prefetch" href="/blog/assets/js/69.16b931a9.js"><link rel="prefetch" href="/blog/assets/js/7.1790a768.js"><link rel="prefetch" href="/blog/assets/js/70.21275219.js"><link rel="prefetch" href="/blog/assets/js/71.8a62669b.js"><link rel="prefetch" href="/blog/assets/js/72.e405af5e.js"><link rel="prefetch" href="/blog/assets/js/73.952bb55c.js"><link rel="prefetch" href="/blog/assets/js/74.fe9094ef.js"><link rel="prefetch" href="/blog/assets/js/75.a676470a.js"><link rel="prefetch" href="/blog/assets/js/76.74d4d72e.js"><link rel="prefetch" href="/blog/assets/js/77.bf122dd4.js"><link rel="prefetch" href="/blog/assets/js/78.098e6fd5.js"><link rel="prefetch" href="/blog/assets/js/79.0389262e.js"><link rel="prefetch" href="/blog/assets/js/8.376aee9a.js"><link rel="prefetch" href="/blog/assets/js/80.88e2fbaa.js"><link rel="prefetch" href="/blog/assets/js/81.9cae08b6.js"><link rel="prefetch" href="/blog/assets/js/82.0b6901f8.js"><link rel="prefetch" href="/blog/assets/js/83.c3b7373f.js"><link rel="prefetch" href="/blog/assets/js/84.9802e521.js"><link rel="prefetch" href="/blog/assets/js/85.a5c05dc4.js"><link rel="prefetch" href="/blog/assets/js/86.8a4cf97b.js"><link rel="prefetch" href="/blog/assets/js/87.c4dc0cd2.js"><link rel="prefetch" href="/blog/assets/js/88.cb71b51a.js"><link rel="prefetch" href="/blog/assets/js/89.d274b621.js"><link rel="prefetch" href="/blog/assets/js/9.1c27384c.js"><link rel="prefetch" href="/blog/assets/js/90.c7d937bc.js"><link rel="prefetch" href="/blog/assets/js/91.ee21252c.js"><link rel="prefetch" href="/blog/assets/js/92.aa8677ee.js"><link rel="prefetch" href="/blog/assets/js/93.5542435e.js"><link rel="prefetch" href="/blog/assets/js/94.b3319c2b.js"><link rel="prefetch" href="/blog/assets/js/95.b1c7df77.js"><link rel="prefetch" href="/blog/assets/js/96.d49b8220.js"><link rel="prefetch" href="/blog/assets/js/97.1f4aa0a3.js"><link rel="prefetch" href="/blog/assets/js/98.0f3cba33.js"><link rel="prefetch" href="/blog/assets/js/99.8b44eb6b.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.9c798782.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">天宝的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="教程" class="dropdown-title"><span class="title">教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/fun/env.html" class="nav-link">环境配置</a></li><li class="dropdown-item"><!----> <a href="/blog/fun/eslint.html" class="nav-link">eslint规则</a></li><li class="dropdown-item"><!----> <a href="/blog/fun/opt.html" class="nav-link">web性能优化</a></li><li class="dropdown-item"><!----> <a href="/blog/fun/wechat.html" class="nav-link">公众号开发总结</a></li><li class="dropdown-item"><!----> <a href="/blog/fun/scaffold.html" class="nav-link">深入浅出前端脚手架</a></li><li class="dropdown-item"><!----> <a href="/blog/fun/md.html" class="nav-link">markdown语法</a></li><li class="dropdown-item"><!----> <a href="/blog/static/1_1.html" class="nav-link">全栈入门</a></li><li class="dropdown-item"><!----> <a href="/blog/js/1.html" class="nav-link">JS入门</a></li><li class="dropdown-item"><!----> <a href="/blog/dd/1-3.html" class="nav-link">JS高级导读</a></li><li class="dropdown-item"><!----> <a href="/blog/fe/vue.html" class="nav-link">前端进阶</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="日常总结" class="dropdown-title"><span class="title">日常总结</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/often/js.html" class="nav-link">JS方法封装</a></li><li class="dropdown-item"><!----> <a href="/blog/often/css.html" class="nav-link">CSS样式封装</a></li><li class="dropdown-item"><!----> <a href="/blog/often/scratch1.html" class="nav-link">Scratch篇</a></li><li class="dropdown-item"><!----> <a href="/blog/phone/optimize.html" class="nav-link">移动端优化与踩坑</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="webpack知识" class="dropdown-title"><span class="title">webpack知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/webpack/webpack-base.html" class="nav-link">webpack入门</a></li><li class="dropdown-item"><!----> <a href="/blog/webpack/webpack-note.html" class="nav-link">webpack随手记</a></li><li class="dropdown-item"><!----> <a href="/blog/webpack/webpack-vue.html" class="nav-link">webpack配置vue</a></li><li class="dropdown-item"><!----> <a href="/blog/webpack/webpack.html" class="nav-link">深入webpack</a></li><li class="dropdown-item"><!----> <a href="/blog/webpack/webpack-opt.html" class="nav-link">webpack4 拆包</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="重点技术" class="dropdown-title"><span class="title">重点技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/skulpt/1.html" class="nav-link">深入skulpt</a></li><li class="dropdown-item"><!----> <a href="/blog/scratch/links.html" class="nav-link">深入scratch</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实战分享" class="dropdown-title"><span class="title">实战分享</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/share/env.html" class="nav-link">开发环境配置参考</a></li><li class="dropdown-item"><!----> <a href="/blog/share/ssr.html" class="nav-link">vue服务端渲染</a></li><li class="dropdown-item"><!----> <a href="/blog/share/mp.html" class="nav-link">小程序开发总结</a></li><li class="dropdown-item"><!----> <a href="/blog/share/iris.html" class="nav-link">go+vue前后端分离实战</a></li><li class="dropdown-item"><!----> <a href="/blog/share/uni.html" class="nav-link">uni-app多端开发回顾</a></li><li class="dropdown-item"><!----> <a href="/blog/share/koa.html" class="nav-link">koa+vue全栈开发实战</a></li></ul></div></div><div class="nav-item"><a href="/blog/url/fe.html" class="nav-link">常用网址</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="教程" class="dropdown-title"><span class="title">教程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/fun/env.html" class="nav-link">环境配置</a></li><li class="dropdown-item"><!----> <a href="/blog/fun/eslint.html" class="nav-link">eslint规则</a></li><li class="dropdown-item"><!----> <a href="/blog/fun/opt.html" class="nav-link">web性能优化</a></li><li class="dropdown-item"><!----> <a href="/blog/fun/wechat.html" class="nav-link">公众号开发总结</a></li><li class="dropdown-item"><!----> <a href="/blog/fun/scaffold.html" class="nav-link">深入浅出前端脚手架</a></li><li class="dropdown-item"><!----> <a href="/blog/fun/md.html" class="nav-link">markdown语法</a></li><li class="dropdown-item"><!----> <a href="/blog/static/1_1.html" class="nav-link">全栈入门</a></li><li class="dropdown-item"><!----> <a href="/blog/js/1.html" class="nav-link">JS入门</a></li><li class="dropdown-item"><!----> <a href="/blog/dd/1-3.html" class="nav-link">JS高级导读</a></li><li class="dropdown-item"><!----> <a href="/blog/fe/vue.html" class="nav-link">前端进阶</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="日常总结" class="dropdown-title"><span class="title">日常总结</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/often/js.html" class="nav-link">JS方法封装</a></li><li class="dropdown-item"><!----> <a href="/blog/often/css.html" class="nav-link">CSS样式封装</a></li><li class="dropdown-item"><!----> <a href="/blog/often/scratch1.html" class="nav-link">Scratch篇</a></li><li class="dropdown-item"><!----> <a href="/blog/phone/optimize.html" class="nav-link">移动端优化与踩坑</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="webpack知识" class="dropdown-title"><span class="title">webpack知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/webpack/webpack-base.html" class="nav-link">webpack入门</a></li><li class="dropdown-item"><!----> <a href="/blog/webpack/webpack-note.html" class="nav-link">webpack随手记</a></li><li class="dropdown-item"><!----> <a href="/blog/webpack/webpack-vue.html" class="nav-link">webpack配置vue</a></li><li class="dropdown-item"><!----> <a href="/blog/webpack/webpack.html" class="nav-link">深入webpack</a></li><li class="dropdown-item"><!----> <a href="/blog/webpack/webpack-opt.html" class="nav-link">webpack4 拆包</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="重点技术" class="dropdown-title"><span class="title">重点技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/skulpt/1.html" class="nav-link">深入skulpt</a></li><li class="dropdown-item"><!----> <a href="/blog/scratch/links.html" class="nav-link">深入scratch</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实战分享" class="dropdown-title"><span class="title">实战分享</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/share/env.html" class="nav-link">开发环境配置参考</a></li><li class="dropdown-item"><!----> <a href="/blog/share/ssr.html" class="nav-link">vue服务端渲染</a></li><li class="dropdown-item"><!----> <a href="/blog/share/mp.html" class="nav-link">小程序开发总结</a></li><li class="dropdown-item"><!----> <a href="/blog/share/iris.html" class="nav-link">go+vue前后端分离实战</a></li><li class="dropdown-item"><!----> <a href="/blog/share/uni.html" class="nav-link">uni-app多端开发回顾</a></li><li class="dropdown-item"><!----> <a href="/blog/share/koa.html" class="nav-link">koa+vue全栈开发实战</a></li></ul></div></div><div class="nav-item"><a href="/blog/url/fe.html" class="nav-link">常用网址</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>前端教程</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/fe/vue.html" class="sidebar-link">vue源码分析</a></li><li><a href="/blog/fe/VueRouter.html" class="active sidebar-link">VueRouter 源码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/fe/VueRouter.html#如何使用" class="sidebar-link">如何使用</a></li><li class="sidebar-sub-header"><a href="/blog/fe/VueRouter.html#vue-router-的入口" class="sidebar-link">Vue-Router 的入口</a></li><li class="sidebar-sub-header"><a href="/blog/fe/VueRouter.html#vuerouter-对象" class="sidebar-link">VueRouter 对象</a></li></ul></li><li><a href="/blog/fe/vuex.html" class="sidebar-link">Vuex源码分析</a></li><li><a href="/blog/fe/linux.html" class="sidebar-link">Linux 入门</a></li><li><a href="/blog/fe/vscode.html" class="sidebar-link">推荐 vscode</a></li><li><a href="/blog/fe/node.html" class="sidebar-link">关于nodejs</a></li><li><a href="/blog/fe/code.html" class="sidebar-link">代码规范</a></li><li><a href="/blog/fe/suanfa.html" class="sidebar-link">常见算法</a></li><li><a href="/blog/fe/ngnix.html" class="sidebar-link">关于ngnix</a></li><li><a href="/blog/fe/pm2.html" class="sidebar-link">pm2 部署</a></li><li><a href="/blog/fe/ssh.html" class="sidebar-link">web安全</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vuerouter-源码"><a href="#vuerouter-源码" class="header-anchor">#</a> VueRouter 源码</h1> <p>路由的作用就是根据不同的路径映射到不同的视图，Vue 是一个渐进式 JavaScript 框架，本身的核心是解决视图渲染的问题，其它的能力就通过插件的方式来解决。</p> <h2 id="如何使用"><a href="#如何使用" class="header-anchor">#</a> 如何使用</h2> <p>vue官方提供Vue-Router 这个插件来帮我们解决路由的问题，支持 hash、history、abstract 3 种路由方式，提供了 router-link 和 router-view 2 种组件，还提供了简单的路由配置和一系列好用的 API。</p> <p>Vue 提供了 Vue.use 的全局 API 来注册这些插件，定义在 vue/src/core/global-api/use.js ：</p> <div class="language- extra-class"><pre class="language-text"><code>export function initUse (Vue: GlobalAPI) {
  Vue.use = function (plugin: Function | Object) {
    const installedPlugins = (this._installedPlugins || (this._installedPlugins = []))
    if (installedPlugins.indexOf(plugin) &gt; -1) {
      return this
    }

    const args = toArray(arguments, 1)
    args.unshift(this)
    if (typeof plugin.install === 'function') {
      plugin.install.apply(plugin, args)
    } else if (typeof plugin === 'function') {
      plugin.apply(null, args)
    }
    installedPlugins.push(plugin)
    return this
  }
}
</code></pre></div><p>Vue.use 接受一个 plugin 参数，并且维护了一个 _installedPlugins 数组，它存储所有注册过的 plugin；接着又会判断 plugin 有没有定义 install 方法，如果有的话则调用该方法，并且该方法执行的第一个参数是 Vue；最后把 plugin 存储到 installedPlugins 中。</p> <p>每个插件都需要实现一个静态的 install 方法，当我们执行 Vue.use 注册插件的时候，就会执行这个 install 方法，并且在这个 install 方法的第一个参数我们可以拿到 Vue 对象。</p> <h2 id="vue-router-的入口"><a href="#vue-router-的入口" class="header-anchor">#</a> Vue-Router 的入口</h2> <p>入口在src/index.js，其中定义了 VueRouter 类，也实现了 install 的静态方法：VueRouter.install = install，定义在 src/install.js 中：</p> <div class="language- extra-class"><pre class="language-text"><code>export let _Vue
export function install (Vue) {
  if (install.installed &amp;&amp; _Vue === Vue) return
  install.installed = true

  _Vue = Vue

  const isDef = v =&gt; v !== undefined

  const registerInstance = (vm, callVal) =&gt; {
    let i = vm.$options._parentVnode
    if (isDef(i) &amp;&amp; isDef(i = i.data) &amp;&amp; isDef(i = i.registerRouteInstance)) {
      i(vm, callVal)
    }
  }

  Vue.mixin({
    beforeCreate () {
      if (isDef(this.$options.router)) {
        this._routerRoot = this
        this._router = this.$options.router
        this._router.init(this)
        Vue.util.defineReactive(this, '_route', this._router.history.current)
      } else {
        this._routerRoot = (this.$parent &amp;&amp; this.$parent._routerRoot) || this
      }
      registerInstance(this, this)
    },
    destroyed () {
      registerInstance(this)
    }
  })

  Object.defineProperty(Vue.prototype, '$router', {
    get () { return this._routerRoot._router }
  })

  Object.defineProperty(Vue.prototype, '$route', {
    get () { return this._routerRoot._route }
  })

  Vue.component('RouterView', View)
  Vue.component('RouterLink', Link)

  const strats = Vue.config.optionMergeStrategies
  strats.beforeRouteEnter = strats.beforeRouteLeave = strats.beforeRouteUpdate = strats.created
}
</code></pre></div><p>当用户执行 Vue.use(VueRouter) 的时候，实际上就是在执行 install 函数，为了确保 install 逻辑只执行一次，用了 install.installed 变量做已安装的标志位。</p> <p>Vue-Router 安装最重要的一步就是利用 Vue.mixin 去把 beforeCreate 和 destroyed 钩子函数注入到每一个组件中。Vue.mixin 的定义，在 vue/src/core/global-api/mixin.js 中：</p> <div class="language- extra-class"><pre class="language-text"><code>export function initMixin (Vue: GlobalAPI) {
  Vue.mixin = function (mixin: Object) {
    this.options = mergeOptions(this.options, mixin)
    return this
  }
}
</code></pre></div><p>把要混入的对象通过 mergeOption 合并到 Vue 的 options 中，由于每个组件的构造函数都会在 extend 阶段合并 Vue.options 到自身的 options 中，所以也就相当于每个组件都定义了 mixin 定义的选项。</p> <p>回到 Vue-Router 的 install 方法，先看混入的 beforeCreate 钩子函数，对于根 Vue 实例而言，执行该钩子函数时定义了 this._routerRoot 表示它自身；this._router 表示 VueRouter 的实例 router，它是在 new Vue 的时候传入的；另外执行了 this._router.init() 方法初始化 router，这个逻辑之后介绍，然后用 defineReactive 方法把 this._route 变成响应式对象，这个作用我们之后会介绍。</p> <p>而对于子组件而言，由于组件是树状结构，在遍历组件树的过程中，它们在执行该钩子函数的时候 this._routerRoot 始终指向的是根 Vue 实例。</p> <p>接着给 Vue 原型上定义了 $router 和 $route 2 个属性的 get 方法，这就是为什么我们可以在组件实例上可以访问 this.$router 以及 this.$route。</p> <p>接着又通过 Vue.component 方法定义了全局的 router-link 和 router-view 2 个组件，最后定义了路由中的钩子函数的合并策略，和普通的钩子函数一样。</p> <p>总之，Vue-Router 的 install 方法会给每一个组件注入 beforeCreate 和 destoryed 钩子函数，在 beforeCreate 做一些私有属性定义和路由初始化工作。</p> <h2 id="vuerouter-对象"><a href="#vuerouter-对象" class="header-anchor">#</a> VueRouter 对象</h2> <p>VueRouter 的实现是一个类，我们先对它做一个简单地分析，它的定义在 src/index.js 中：</p> <div class="language- extra-class"><pre class="language-text"><code>export default class VueRouter {
  static install: () =&gt; void;
  static version: string;

  app: any;
  apps: Array&lt;any&gt;;
  ready: boolean;
  readyCbs: Array&lt;Function&gt;;
  options: RouterOptions;
  mode: string;
  history: HashHistory | HTML5History | AbstractHistory;
  matcher: Matcher;
  fallback: boolean;
  beforeHooks: Array&lt;?NavigationGuard&gt;;
  resolveHooks: Array&lt;?NavigationGuard&gt;;
  afterHooks: Array&lt;?AfterNavigationHook&gt;;

  constructor (options: RouterOptions = {}) {
    this.app = null
    this.apps = []
    this.options = options
    this.beforeHooks = []
    this.resolveHooks = []
    this.afterHooks = []
    this.matcher = createMatcher(options.routes || [], this)

    let mode = options.mode || 'hash'
    this.fallback = mode === 'history' &amp;&amp; !supportsPushState &amp;&amp; options.fallback !== false
    if (this.fallback) {
      mode = 'hash'
    }
    if (!inBrowser) {
      mode = 'abstract'
    }
    this.mode = mode

    switch (mode) {
      case 'history':
        this.history = new HTML5History(this, options.base)
        break
      case 'hash':
        this.history = new HashHistory(this, options.base, this.fallback)
        break
      case 'abstract':
        this.history = new AbstractHistory(this, options.base)
        break
      default:
        if (process.env.NODE_ENV !== 'production') {
          assert(false, `invalid mode: ${mode}`)
        }
    }
  }

  match (
    raw: RawLocation,
    current?: Route,
    redirectedFrom?: Location
  ): Route {
    return this.matcher.match(raw, current, redirectedFrom)
  }

  get currentRoute (): ?Route {
    return this.history &amp;&amp; this.history.current
  }

  init (app: any) {
    process.env.NODE_ENV !== 'production' &amp;&amp; assert(
      install.installed,
      `not installed. Make sure to call \`Vue.use(VueRouter)\` ` +
      `before creating root instance.`
    )

    this.apps.push(app)

    if (this.app) {
      return
    }

    this.app = app

    const history = this.history

    if (history instanceof HTML5History) {
      history.transitionTo(history.getCurrentLocation())
    } else if (history instanceof HashHistory) {
      const setupHashListener = () =&gt; {
        history.setupListeners()
      }
      history.transitionTo(
        history.getCurrentLocation(),
        setupHashListener,
        setupHashListener
      )
    }

    history.listen(route =&gt; {
      this.apps.forEach((app) =&gt; {
        app._route = route
      })
    })
  }

  beforeEach (fn: Function): Function {
    return registerHook(this.beforeHooks, fn)
  }

  beforeResolve (fn: Function): Function {
    return registerHook(this.resolveHooks, fn)
  }

  afterEach (fn: Function): Function {
    return registerHook(this.afterHooks, fn)
  }

  onReady (cb: Function, errorCb?: Function) {
    this.history.onReady(cb, errorCb)
  }

  onError (errorCb: Function) {
    this.history.onError(errorCb)
  }

  push (location: RawLocation, onComplete?: Function, onAbort?: Function) {
    this.history.push(location, onComplete, onAbort)
  }

  replace (location: RawLocation, onComplete?: Function, onAbort?: Function) {
    this.history.replace(location, onComplete, onAbort)
  }

  go (n: number) {
    this.history.go(n)
  }

  back () {
    this.go(-1)
  }

  forward () {
    this.go(1)
  }

  getMatchedComponents (to?: RawLocation | Route): Array&lt;any&gt; {
    const route: any = to
      ? to.matched
        ? to
        : this.resolve(to).route
      : this.currentRoute
    if (!route) {
      return []
    }
    return [].concat.apply([], route.matched.map(m =&gt; {
      return Object.keys(m.components).map(key =&gt; {
        return m.components[key]
      })
    }))
  }

  resolve (
    to: RawLocation,
    current?: Route,
    append?: boolean
  ): {
    location: Location,
    route: Route,
    href: string,
    normalizedTo: Location,
    resolved: Route
  } {
    const location = normalizeLocation(
      to,
      current || this.history.current,
      append,
      this
    )
    const route = this.match(location, current)
    const fullPath = route.redirectedFrom || route.fullPath
    const base = this.history.base
    const href = createHref(base, fullPath, this.mode)
    return {
      location,
      route,
      href,
      normalizedTo: location,
      resolved: route
    }
  }

  addRoutes (routes: Array&lt;RouteConfig&gt;) {
    this.matcher.addRoutes(routes)
    if (this.history.current !== START) {
      this.history.transitionTo(this.history.getCurrentLocation())
    }
  }
}
VueRouter 定义了一些属性和方法，我们先从它的构造函数看，当我们执行 new VueRouter 的时候做了哪些事情。

constructor (options: RouterOptions = {}) {
  this.app = null
  this.apps = []
  this.options = options
  this.beforeHooks = []
  this.resolveHooks = []
  this.afterHooks = []
  this.matcher = createMatcher(options.routes || [], this)

  let mode = options.mode || 'hash'
  this.fallback = mode === 'history' &amp;&amp; !supportsPushState &amp;&amp; options.fallback !== false
  if (this.fallback) {
    mode = 'hash'
  }
  if (!inBrowser) {
    mode = 'abstract'
  }
  this.mode = mode

  switch (mode) {
    case 'history':
      this.history = new HTML5History(this, options.base)
      break
    case 'hash':
      this.history = new HashHistory(this, options.base, this.fallback)
      break
    case 'abstract':
      this.history = new AbstractHistory(this, options.base)
      break
    default:
      if (process.env.NODE_ENV !== 'production') {
        assert(false, `invalid mode: ${mode}`)
      }
  }
}
</code></pre></div><p>构造函数定义了一些属性，其中 this.app 表示根 Vue 实例，this.apps 保存持有 $options.router 属性的 Vue 实例，this.options 保存传入的路由配置，this.beforeHooks、 this.resolveHooks、this.afterHooks 表示一些钩子函数，this.matcher 表示路由匹配器，this.fallback 表示在浏览器不支持 history.pushState 的情况下，根据传入的 fallback 配置参数，决定是否回退到hash模式，this.mode 表示路由创建的模式，this.history 表示路由历史的具体的实现实例，它是根据 this.mode 的不同实现不同，它有 History 基类，然后不同的 history 实现都是继承 History。</p> <p>在组件的初始化阶段，执行到 beforeCreate 钩子函数的时候会执行 router.init 方法，然后又会执行 history.transitionTo 方法做路由过渡。实例化 VueRouter 后会返回它的实例 router，我们在 new Vue 的时候会把 router 作为配置的属性传入：</p> <div class="language- extra-class"><pre class="language-text"><code>beforeCreate() {
  if (isDef(this.$options.router)) {
    // ...
    this._router = this.$options.router
    this._router.init(this)
    // ...
  }
}  
</code></pre></div><p>所以组件在执行 beforeCreate 钩子函数的时候，如果传入了 router 实例，都会执行 router.init 方法：</p> <div class="language- extra-class"><pre class="language-text"><code>init (app: any) {
  process.env.NODE_ENV !== 'production' &amp;&amp; assert(
    install.installed,
    `not installed. Make sure to call \`Vue.use(VueRouter)\` ` +
    `before creating root instance.`
  )

  this.apps.push(app)

  if (this.app) {
    return
  }

  this.app = app

  const history = this.history

  if (history instanceof HTML5History) {
    history.transitionTo(history.getCurrentLocation())
  } else if (history instanceof HashHistory) {
    const setupHashListener = () =&gt; {
      history.setupListeners()
    }
    history.transitionTo(
      history.getCurrentLocation(),
      setupHashListener,
      setupHashListener
    )
  }

  history.listen(route =&gt; {
    this.apps.forEach((app) =&gt; {
      app._route = route
    })
  })
}
</code></pre></div><p>init 的逻辑很简单，它传入的参数是 Vue 实例，然后存储到 this.apps 中；只有根 Vue 实例会保存到 this.app 中，并且会拿到当前的 this.history，根据它的不同类型来执行不同逻辑。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/fe/vue.html" class="prev">vue源码分析</a></span> <span class="next"><a href="/blog/fe/vuex.html">Vuex源码分析</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.aa3db317.js" defer></script><script src="/blog/assets/js/2.88c654cf.js" defer></script><script src="/blog/assets/js/23.af7d3482.js" defer></script>
  </body>
</html>
